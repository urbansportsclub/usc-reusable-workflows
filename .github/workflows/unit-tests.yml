name: Unit Tests
on:
  workflow_call:
    inputs:
      REPO_NAME:
        required: true
        type: string
      USE_CODECOV:
        required: false
        type: boolean
        # this should be FALSE by default but as of now onefit B2B has a dependency and we would
        # need to make a change in there
        default: true
      UPLOAD_ARTIFACTS:
        required: false
        type: boolean
        default: false
      WORKING_DIRECTORY:
        type: string
        default: "."
        required: false
      PACKAGE_MANAGER:
        type: string
        default: "yarn"
        required: false
    secrets:
      GH_PACKAGES_TOKEN:
        required: true
      CODECOV_TOKEN:
        required: false
jobs:
  unit_tests:
    name: Jest
    runs-on: [self-hosted, deploy]
    defaults:
      run:
        working-directory: ${{ inputs.WORKING_DIRECTORY }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      
      # Restore NPM cache
      - if: ${{ inputs.PACKAGE_MANAGER == 'yarn' }}
        name: Restore `node_modules` - yarn
        uses: actions/cache@v4
        id: node-cache-yarn
        with:
          path: |
            ./node_modules
            /home/runner/.cache/Cypress
          key: node-cache-${{ runner.os }}-${{ hashFiles('./yarn.lock') }}
      
      - if: ${{ inputs.PACKAGE_MANAGER == 'npm' }}
        name: Restore `node_modules` - npm
        uses: actions/cache@v4
        id: node-cache-npm
        with:
          path: |
            ./node_modules
            /home/runner/.cache/Cypress
          key: node-cache-${{ runner.os }}-${{ hashFiles('./package-lock.json') }}

      - name: List Directory Files
        run: ls -la

      - name: Set Node version
        uses: actions/setup-node@v4
        with:
          node-version-file: ${{ inputs.WORKING_DIRECTORY }}/.nvmrc
          registry-url: 'https://npm.pkg.github.com'

      - if: ${{ inputs.PACKAGE_MANAGER == 'yarn' && steps.node-cache-yarn.outputs.cache-hit != 'true' }}
        name: Install NPM dependencies - Yarn
        run: |
          npm install -g yarn
          yarn --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      - if: ${{ inputs.PACKAGE_MANAGER == 'npm' && steps.node-cache-npm.outputs.cache-hit != 'true' }}
        name: Clean Install Dependencies - NPM
        run: npm ci
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      # Unit Tests
      - if: ${{ inputs.PACKAGE_MANAGER == 'yarn' }}
        name: Jest - Yarn
        run: yarn jest:run

      - if: ${{ inputs.PACKAGE_MANAGER == 'npm' }}
        name: Jest - NPM
        run: npm run test

      # Upload test coverage report to CodeCov
      - name: Codecov
        if: ${{ inputs.USE_CODECOV }}
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./coverage
          flags: Jest
          name: ${{ inputs.REPO_NAME }}
          fail_ci_if_error: true
          verbose: true

      - name: Upload Code Coverage Artifacts to test-artifacts
        uses: actions/upload-artifact@v4
        if: ${{ inputs.UPLOAD_ARTIFACTS }}
        with:
          name: test-artifacts
          path: ${{ inputs.WORKING_DIRECTORY }}/coverage
