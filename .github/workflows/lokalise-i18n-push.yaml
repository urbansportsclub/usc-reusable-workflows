name: Lokalise I18N Push
run-name: Push translation keys up to Lokalise [${{ github.ref_name }}]
on:
  workflow_call:
    inputs:
      I18N_DIR_PATH:
        required: true
        description: "Path to the directory containing the i18n files. Leave out leading slashes e.g., 'src/lib/i18n/'"
        type: string
      LOKALISE_PROJECT_ID:
        required: true
        description: "Auto-generated Lokalise Project ID"
        type: string
      I18N_FILE_FORMAT:
        required: false
        type: string
        description: "File format for the translations, default is 'json'"
        default: "json"
    secrets:
      LOKALISE_API_TOKEN:
        required: true
        description: "Lokalise API token for authentication"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push dir of files up to Lokalise
        env:
          ENV_I18N_DIR_PATH: ${{ inputs.I18N_DIR_PATH }}
          ENV_I18N_FILE_FORMAT: ${{ inputs.I18N_FILE_FORMAT }}
          ENV_LOKALISE_PROJECT_ID: ${{ inputs.LOKALISE_PROJECT_ID }}
          ENV_LOKALISE_API_TOKEN: ${{ secrets.LOKALISE_API_TOKEN }}
        run: |
          find "$ENV_I18N_DIR_PATH" -type f -name "*.$ENV_I18N_FILE_FORMAT" | while read -r file; do
            LANG_ISO=$(basename "$file" ".$ENV_I18N_FILE_FORMAT")

            echo "Uploading $file (lang: $LANG_ISO)"
            curl -X POST "https://api.lokalise.com/api2/projects/$ENV_LOKALISE_PROJECT_ID/files/upload" \
              -H "x-api-token: $ENV_LOKALISE_API_TOKEN" \
              -F "file=@$file" \
              -F "filename=$(basename "$file")" \
              -F "lang_iso=$LANG_ISO" \
              -F "convert_placeholders=true" \
              -F "cleanup_mode=true" \
              -F "replace_modified=true"
          done
