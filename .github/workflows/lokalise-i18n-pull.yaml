name: Lokalise I18N Pull
run-name: Pull translation keys down from Lokalise [${{ github.ref_name }}]
on:
  workflow_call:
    inputs:
      LOKALISE_PROJECT_ID:
        required: true
        description: "Auto-generated Lokalise Project ID"
        type: string
      DESTINATION_DIR:
        required: true
        description: "Directory to save the downloaded i18n keys. eg. './src/lib/i18n/'"
        type: string
    secrets:
      LOKALISE_API_TOKEN:
        required: true
        description: "Lokalise API token for authentication"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull Zip of i18n keys down from Lokalise
        env:
          ENV_LOKALISE_PROJECT_ID: ${{ inputs.LOKALISE_PROJECT_ID }}
          ENV_LOKALISE_API_TOKEN: ${{ secrets.LOKALISE_API_TOKEN }}
          ENV_DESTINATION_DIR: ${{ inputs.DESTINATION_DIR }}
        run: |
          echo "Downloading Zip of i18n keys from Lokalise..."

          RESPONSE=$(curl -v "https://api.lokalise.com/api2/projects/$ENV_LOKALISE_PROJECT_ID/files/download" \
            --header "x-api-token: $ENV_LOKALISE_API_TOKEN" \
            --header "accept: application/json" \
            --header "content-type: application/json" \
            --data "{
              \"format\": \"json\",
              \"original_filenames\": false,
              \"filter_data\": [
                \"translated\"
              ],
              \"add_newline_eof\": false,
              \"export_sort\": \"a-z\",
              \"export_empty_as\": \"empty\",
              \"replace_breaks\": true
            }")

            RESP_ERR_STATUS=$(echo "$RESPONSE" | jq -r '.error.code')
            RESP_ERR_MSG=$(echo "$RESPONSE" | jq -r '.error.message')

            if [ "$RESP_STATUS" -ne 200 ]; then
              echo "Request failed with status: $RESP_STATUS"
              echo "Error Message: $RESP_MSG"
              exit 2
            fi

            echo "Request successful, processing response..."
            echo "Response: $RESPONSE"

            # RESP_SUCCESS_URL=$(echo "$RESPONSE" | jq -r '.bundle_url')
            # if [[ -n $RESP_SUCCESS_URL ]]; then
            #   echo "Download URL: $RESP_SUCCESS_URL"

            #   ZIP_FILE_NAME="lokalise_i18n_keys_${{ github.run_id }}.zip"
            #   echo "Downloading Zip file to $ZIP_FILE_NAME..."
            #   curl -L -o "$ZIP_FILE_NAME" "$RESP_SUCCESS_URL"
              
            #   echo "Unzipping $ZIP_FILE_NAME..."
            #   unzip -o "$ZIP_FILE_NAME" -d "$ENV_DESTINATION_DIR"
              
            #   echo "Unzipped files to $ENV_DESTINATION_DIR"
            #   rm "$ZIP_FILE_NAME"
            # fi
