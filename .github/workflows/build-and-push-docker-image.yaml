name: Build And Push Docker Images

on:
  workflow_call:
    inputs:
      DOCKERFILE_PATH:
        required: false
        type: string
        description: "Path of the dockerfile" 
        default: "Dockerfile"
      IMAGE_NAME:
        required: true
        type: string
        description: "Name of the docker image" 
        default: "usc-test-image"
      REGISTRY:
        required: false
        type: string
        description: "Registry Address, Most Likely You Do Not Need To Change It" 
        default: "eu.gcr.io"
      REPOSITORY:
        required: true
        type: string
        description: "Repository Name" 
        default: "usc"
      PROJECT_ID:
        required: false
        type: string
        description: "GCP Project ID" 
        default: "urbansportsclub-dev"
      IMAGE_TAG:
        required: true
        type: string
        description: "Image Tag, Please Dont Use Latest!" 
        default: "latest"

jobs:
  buildandpushdocker:
    name: buildandpushdocker
    runs-on: [self-hosted, dind]

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Configure Docker Auth
      run: |-
        gcloud auth configure-docker

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1
      with:
          install: true
          buildkitd-flags: --debug

    - name: Build Docker Dind Image with Github Actions
      run: |-
        docker build \
          --tag "$REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:$IMAGE_TAG" \
          -f $DOCKERFILE_PATH . 

    - name: Publish Docker Dind Image
      run: |-
        docker push "$REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:$IMAGE_TAG"
